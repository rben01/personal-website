<script>
	let footnoteBox;
	let footnoteP;
	const _toc = document.getElementById("toc");

	function showFootnoteBoxOnHover(elem) {
		const FOOTNOTE_BOX_MAX_WIDTH = 400;

		if (footnoteBox === undefined) {
			footnoteBox = document.createElement("div");
			document.body.appendChild(footnoteBox);
			footnoteBox.classList.add("footnote-box");
			footnoteBox.addEventListener("mouseleave", () => removeFootnoteBox());

			footnoteP = document.createElement("p");
			footnoteBox.appendChild(footnoteP);
		}

		// Remove the numbering from this footnote box
		const footnoteId = elem.getAttribute("href"); // Starts with #
		const footnoteClone = document
			.getElementById(footnoteId.substring(1))
			.cloneNode(true);
		const footnoteA = footnoteClone.getElementsByTagName("a")[0];
		footnoteA.remove();

		const footnoteHtml = footnoteClone.innerHTML.replace(/^\s*\.\s*/, "");

		footnoteP.innerHTML = footnoteHtml;
		footnoteBox.style.left = "0px";
		footnoteBox.style.top = "0px";

		const bodyRect = document.body.getBoundingClientRect();
		const elemRect = elem.getBoundingClientRect();

		footnoteBox.style.display = "block";

		const py = -10 + elemRect.top - bodyRect.top;
		footnoteBox.style.top = `${py}px`;

		if (elemRect.right + FOOTNOTE_BOX_MAX_WIDTH > bodyRect.right) {
			const px = bodyRect.right - (bodyRect.left + bodyRect.width) - 40;
			console.log(bodyRect);
			footnoteBox.style.left = null;
			footnoteBox.style.right = `${px}px`;
		} else {
			const px = -10 + elemRect.left - bodyRect.left;
			footnoteBox.style.right = null;
			footnoteBox.style.left = `${px}px`;
		}
	}

	function removeFootnoteBox() {
		if (footnoteBox === undefined) {
			return;
		}
		footnoteBox.style.display = "none";
	}

	function initializeFootnotes() {
		const footnotes = document.querySelectorAll(
			":not(#footnotes) .footnote a.footnote",
		);
		const nFootnotes = footnotes.length;
		for (let i = 0; i < nFootnotes; i++) {
			const footnote = footnotes[i];
			footnote.addEventListener("mouseenter", () =>
				showFootnoteBoxOnHover(footnote),
			);
			// footnote.addEventListener("mouseleave", () => removeFootnoteBox());
		}
	}

	initializeFootnotes();
</script>
